import { Vulnerability } from '../models/Vulnerability';

export class VulnerabilityScanner {
  private static VULNERABILITY_PATTERNS = [
    { pattern: /password\s*=/i, severity: 'high' as const, type: 'Hardcoded credentials' },
    { pattern: /api[_-]?key\s*=/i, severity: 'high' as const, type: 'Hardcoded API key' },
    { pattern: /secret\s*=/i, severity: 'high' as const, type: 'Hardcoded secret' },
    { pattern: /eval\s*\(/i, severity: 'high' as const, type: 'Code injection risk (eval)' },
    { pattern: /exec\s*\(/i, severity: 'high' as const, type: 'Command injection risk' },
    { pattern: /innerHTML/i, severity: 'medium' as const, type: 'XSS vulnerability' },
    { pattern: /dangerouslySetInnerHTML/i, severity: 'medium' as const, type: 'XSS vulnerability' },
    { pattern: /sql\s*injection/i, severity: 'high' as const, type: 'SQL injection' },
    { pattern: /SELECT.*FROM.*WHERE.*\+/i, severity: 'medium' as const, type: 'SQL injection risk' },
    { pattern: /\.env/i, severity: 'medium' as const, type: 'Environment file access' },
    { pattern: /process\.env/i, severity: 'low' as const, type: 'Environment variable usage' },
    { pattern: /crypto\.createHash\('md5'/i, severity: 'medium' as const, type: 'Weak hashing algorithm (MD5)' },
    { pattern: /Math\.random\(\)/i, severity: 'medium' as const, type: 'Weak random number generator' },
    { pattern: /http:\/\//i, severity: 'medium' as const, type: 'Insecure HTTP protocol' },
    { pattern: /console\.log/i, severity: 'low' as const, type: 'Debug code left in production' },
    { pattern: /TODO/i, severity: 'low' as const, type: 'TODO comment found' },
    { pattern: /FIXME/i, severity: 'low' as const, type: 'FIXME comment found' },
    { pattern: /async\s+function\s+\w+\s*\([^)]*\)\s*{[^}]*await\s+[^}]+}/i, severity: 'low' as const, type: 'Async function structure' },
    { pattern: /try\s*{[^}]*}\s*catch\s*\([^)]*\)\s*{[^}]*}/i, severity: 'low' as const, type: 'Try-catch structure' }
  ];

  static detectVulnerabilities(content: string): Vulnerability[] {
    const lines = content.split('\n');
    const vulnerabilities: Vulnerability[] = [];

    this.VULNERABILITY_PATTERNS.forEach(({ pattern, severity, type }) => {
      lines.forEach((line, index) => {
        if (pattern.test(line)) {
          // Get surrounding context (2 lines before and after)
          const start = Math.max(0, index - 2);
          const end = Math.min(lines.length - 1, index + 2);
          const contextCode = lines.slice(start, end + 1).map((l, i) => {
            const lineNum = start + i + 1;
            const marker = lineNum === index + 1 ? '> ' : '  ';
            return `${marker}${lineNum.toString().padStart(4)} | ${l}`;
          }).join('\n');

          vulnerabilities.push({
            line: index + 1,
            type,
            severity,
            code: contextCode
          });
        }
      });
    });

    return vulnerabilities;
  }
}